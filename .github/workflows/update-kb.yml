name: Auto-update Knowledge Base

on:
  push:
    branches: [main]
    paths:
      # App pages (any change to routes triggers KB update)
      - 'src/app/(app)/**/page.tsx'
      - 'src/app/(onboarding)/**/page.tsx'
      # Key components
      - 'src/components/layout/sidebar.tsx'
      - 'src/components/chat/**'
      # Chat tools (affects "what can the bot do" article)
      - 'src/lib/chat/tools.ts'
      # The source map itself
      - 'src/lib/kb/source-map.ts'

jobs:
  update-kb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed files and decide scope
        id: scope
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED"

          # If source-map.ts changed → regenerate ALL
          if echo "$CHANGED" | grep -q "src/lib/kb/source-map.ts"; then
            echo "mode=all" >> $GITHUB_OUTPUT
            echo "Mode: regenerate ALL (source-map changed)"
            exit 0
          fi

          # Otherwise → just run with auto-discovery (only new/changed articles)
          echo "mode=auto" >> $GITHUB_OUTPUT
          echo "Mode: auto-discovery (incremental)"

      - name: Wait for Vercel deploy
        run: |
          echo "Waiting 150s for Vercel deploy..."
          sleep 150

      - name: Regenerate KB articles
        env:
          APP_URL: ${{ secrets.APP_URL }}
          ADMIN_KEY: ${{ secrets.N8N_WEBHOOK_AUTH_VALUE }}
        run: |
          MODE="${{ steps.scope.outputs.mode }}"
          URL="${APP_URL:-https://app.contentflow365.com}"

          if [ "$MODE" = "all" ]; then
            echo "Regenerating ALL articles..."
            BODY='{"regenerate": true}'
          else
            echo "Running incremental update (new pages auto-discovered)..."
            BODY='{}'
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$URL/api/admin/kb/generate" \
            -H "X-Admin-Key: $ADMIN_KEY" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY_RESP=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP $HTTP_CODE"
          echo "$BODY_RESP" | python3 -m json.tool 2>/dev/null || echo "$BODY_RESP"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::warning::KB regeneration returned HTTP $HTTP_CODE"
          fi
